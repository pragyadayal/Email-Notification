name: Check Email Notification

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set default failure message
      id: failure_info
      run: echo "job_reason=Unknown failure" >> "$GITHUB_OUTPUT"

    - name: Compile the program
      id: compile
      run: make
      continue-on-error: true

    - name: Set compile failure reason
      if: steps.compile.outcome == 'failure'
      run: echo "job_reason=Compilation Failure" >> "$GITHUB_OUTPUT"

    - name: Upload artifact to JFrog Artifactory
      id: upload
      if: steps.compile.outcome == 'success'
      run: |
        curl -u ${{ secrets.JFROG_USER }}:${{ secrets.JFROG_PASSWORD }} \
          -T ./main "https://192.168.27.95/artifactory/example-repo-local/"
      continue-on-error: true

    - name: Set JFrog failure reason
      if: steps.upload.outcome == 'failure'
      run: |
        echo "job_reason=Upload Failure to JFrog Artifactory at https://192.168.27.95/artifactory/example-repo-local/" >> "$GITHUB_OUTPUT"

    - name: Export job reason for other jobs
      run: echo "JOB_REASON=${{ steps.failure_info.outputs.job_reason }}" >> $GITHUB_ENV

  notify-success:
    needs: build
    if: success()
    runs-on: self-hosted

    steps:
    - name: Send Success Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_FROM }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âœ… SUCCESS: ${{ github.repository }} on ${{ github.ref_name }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_FROM }}
        body: |
          âœ… Build Succeeded!

          ğŸ”§ Job: build
          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          ğŸ’¬ Commit ID: ${{ github.sha }}
          ğŸ§‘â€ğŸ’» Triggered by: ${{ github.actor }}
          ğŸ”— Check Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-failure:
    needs: build
    if: failure()
    runs-on: self-hosted

    steps:
    - name: Send Failure Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_FROM }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âŒ FAILURE: ${{ github.repository }} on ${{ github.ref_name }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_FROM }}
        body: |
          â— Build Failed
          ğŸ”§ Job: ${{ env.JOB_REASON }}
          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          ğŸ’¬ Commit ID: ${{ github.sha }}
          ğŸ§‘â€ğŸ’» Triggered by: ${{ github.actor }}
          ğŸ”— Check Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
